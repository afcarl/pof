\documentclass{article}
\usepackage[top=1in, bottom=1in, left=1in, right=1in]{geometry}
\usepackage{amsmath,cite}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{times, epsfig, graphicx,url, bm}
\usepackage{amssymb}
\usepackage{epstopdf}
\usepackage{tikz}
\usetikzlibrary{bayesnet}

\DeclareMathOperator*{\argmax}{arg\,max}


% Title.
% ------
\title{Dictionary Prior $P(W)$}
\author{
Dawen Liang \\
\texttt{daliang@adobe.com}
} \date{}

\begin{document}
%
\maketitle
%

\section{Source-filter model (version 1)}
\begin{figure}[ht]
  \centering
      \input{pw_v1}
  \caption{Version 1}
\label{fig:plate}
\end{figure}

Model formulation:
\[
\bm{w}_n \in \mathbb{R}_{+}^{F} \qquad \bm{a}_n \in \mathbb{R}_{+}^{L} \qquad \bm{u}_l  \in \mathbb{R}_{+}^{F}\\
\]
\begin{align*}
a_{nl} &\sim \Gamma(\alpha_l, \alpha_l)\\
\log {w}_{nf} &\sim \mathcal{N}(\sum_{l=1}^L a_{nl} u_{lf}, 1/\gamma_f)
\end{align*}

Objective:
\begin{align*}
\hat{\mathbf{U}}, \hat{\bm{\alpha}}, \hat{\bm{\gamma}} &= \argmax_{\mathbf{U}, \bm{\alpha}, \bm{\gamma}} \sum_n \log P(\bm{w}_n | \mathbf{U}, \bm{\alpha}, \bm{\gamma})\\
&= \argmax_{\mathbf{U}, \bm{\alpha}, \bm{\gamma}} \sum_n \log \int_{\bm{a}_n} P(\bm{w}_n, \bm{a}_n | \mathbf{U}, \bm{\alpha}, \bm{\gamma}) \mathrm{d} \bm{a}_n
\end{align*}


\subsection{Variational EM:}

\paragraph{E-step:} 
\begin{itemize}
\item Reparametrize $v_{nf} \equiv \log w_{nf}$ and $\phi_{nl} \equiv \log a_{nl}$.
\item Approximate posterior $P(\bm{a}_n | \mathbf{U}, \bm{w}_n, \bm{\alpha}, \bm{\gamma}) = \prod_{l} q(a_{nl})$
\begin{align*}
q(a_{nl}) &\propto \exp \{ (\alpha_l - 1) \log a_{nl} - \alpha_l a_{nl} - \frac{1}{2} \sum_f \gamma_f  \langle (v_{nf} - \sum_k a_{nk} u_{kf})^2 \rangle \}\\
\Rightarrow q(\phi_{nl}) &\propto \exp \{ \alpha_l  \phi_{nl} - \alpha_l \exp(\phi_{nl}) + \sum_f \gamma_f \biggl[\exp(\phi_{nl}) u_{lf} \hat{v}_{nf}^{-l} - \frac{1}{2} \exp(2\phi_{nl}) u_{lf}^2 \biggl] \}\\
&= \exp\{f(\phi_{nl})\}
\end{align*}
where 
\[
\hat{v}_{nf}^{-l} = v_{nf} - \sum_{k\neq l} \langle \exp(\phi_{nk})\rangle u_{kf}
\]

With Laplace approximation variational inference, $q(\phi_{nl}) = \mathcal{N}(\mu_{nl}, \sigma_{nl}^2)$. Searching for the local maximum $\hat{\phi}_{nl}$ of $f(\phi_{nl})$:
\begin{align*}
\mu_{nl} &\leftarrow \hat{\phi}_{nl}\\
\sigma_{nl}^2 & \leftarrow -\biggl(\frac{\partial^2 f } {\partial \phi_{nl}^2} (\hat{\phi}_{nl})\biggl)^{-1}
\end{align*}

\end{itemize}

\paragraph{M-step:}

The objective function for M-step is:
\begin{align*}
\mathcal{L}(\mathbf{U}, \bm{\alpha}, \bm{\gamma}) &= \sum_n \mathbb{E}_{q(\bm{a}_n)}[\log P(\bm{w}_n, \bm{a}_n | \mathbf{U}, \bm{\alpha}, \bm{\gamma})]\\
&\propto \sum_n \mathbb{E}_{q(\bm{a}_n)} \left\{ \frac{1}{2}\sum_f \biggl[ \log \gamma_f - \gamma_f (v_{nf} - \sum_k a_{nk} u_{kf})^2 \biggl] + \sum_l \biggl[ \alpha_l \log \alpha_l - \log \Gamma(\alpha_l) + (\alpha_l - 1)\log a_{nl} - \alpha_l a_{nl}  \biggl] \right\}
\end{align*}

Take the derivative w.r.t. $\mathbf{U}, \bm{\alpha}, \bm{\gamma}$, respectively:
\begin{align*}
\frac{\partial \mathcal{L}}{\partial u_{lf}} &\propto \sum_n \biggl( \langle a_{nl} \rangle \hat{v}_{nf}^{-l} - \langle a_{nl}^2 \rangle u_{lf} \biggl)\\
\frac{\partial \mathcal{L}}{\partial \alpha_l} &\propto  \sum_n \biggl( \log \alpha_l + 1 - \psi(\alpha_l) + \langle \log a_{nl} \rangle - \langle a_{nl} \rangle \biggl)\\
\frac{\partial \mathcal{L}}{\partial \gamma_f} &\propto \sum_n \frac{1}{\gamma_f} -  \biggl(v_{nf}^2 - 2 v_{nf}  \sum_k \langle a_{nk} \rangle u_{kf} +  \langle (\sum_k a_{nk} u_{kf})^2 \rangle \biggl)
\end{align*}
where 
\[
\langle (\sum_k a_{nk} u_{kf})^2 \rangle = \sum_k \langle a_{nk}^2 \rangle u_{kf}^2 + (\sum_k \langle a_{nk} \rangle u_{kf})^2 - \sum_k \langle a_{nk}\rangle ^2 u_{kf}^2
\]
and
\begin{align*}
&\langle a_{nl} \rangle = \exp(\mu_{nl} + \frac{\sigma_{nl}^2}{2})\\
&\langle a_{nl}^2 \rangle = \exp(2\mu_{nl} + 2\sigma_{nl}^2)\\
&\langle \log a_{nl} \rangle = \mu_{nl}
\end{align*}

Note that for $\gamma_f$, closed form update is available:
\begin{equation*}
\gamma_f^{-1} = \frac{1}{N}\sum_n \biggl(v_{nf}^2 - 2 v_{nf}  \sum_k \langle a_{nk} \rangle u_{kf} +  \langle (\sum_k a_{nk} u_{kf})^2 \rangle \biggl)
\end{equation*}

While for $U$ and $\alpha$, L-BFGS can be applied to find a local optimum. Note that since $\alpha_l > 0$ which can be problematic for numerical solver, we log-transform $\eta_l \equiv \log \alpha_l$ and optimize w.r.t. $\eta_l$, where the derivative can be simply modified by chain rule:
\[
\frac{\partial \mathcal{L}}{\partial \eta_l} = \frac{\partial \mathcal{L}}{\partial \alpha_l} \cdot \frac{\partial \alpha_l}{\partial \eta_l} = \alpha_l \frac{\partial \mathcal{L}}{\partial \alpha_l} 
\]

\end{document}
